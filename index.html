<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¯¸ë¡œ íƒìƒ‰ ì‹œë®¬ë ˆì´ì…˜</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    background: #080818; color: #ccd;
    font-family: 'Segoe UI', Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center;
    padding: 12px 8px 28px;
}
h1 { color: #99aaff; font-size: 1.15em; margin-bottom: 10px; letter-spacing: 1px; }
.row {
    display: flex; align-items: center; gap: 7px;
    margin-bottom: 7px; flex-wrap: wrap; justify-content: center;
}
button { padding: 6px 13px; border: none; border-radius: 6px; cursor: pointer;
    font-size: 13px; font-weight: 700; transition: transform .1s, filter .15s; }
button:hover  { filter: brightness(1.3); }
button:active { transform: scale(.95); }
#btnNew   { background: #2255cc; color: #eef; }
#btnStart { background: #1a7a3c; color: #efe; }
#btnStop  { background: #aa2211; color: #fee; }
#sndBtn { padding: 5px 10px; border-radius: 20px; font-size: 12px;
    background: #1a3a2a; border: 1px solid #3a6; color: #6d6; cursor: pointer; }
#sndBtn.off { background: #1a1a2a; border-color: #335; color: #557; }
.lbl { font-size: 12px; color: #778; }
input[type=range]  { width: 95px; accent-color: #5577ff; cursor: pointer; }
input[type=number] { width: 52px; padding: 4px 6px; background: #111128;
    border: 1px solid #335; border-radius: 4px; color: #aabf; font-size: 13px; text-align: center; }
#spdLbl { min-width: 20px; color: #aabf; font-size: 12px; }

/* Algorithm grid: 2 rows Ã— 4 */
.algo-grid {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 6px; margin-bottom: 7px; max-width: 380px; width: 100%;
}
.abtn {
    display: flex; flex-direction: column; align-items: center; gap: 2px;
    padding: 6px 4px; background: #111128; border: 1px solid #222244;
    border-radius: 9px; cursor: pointer; transition: all .2s; color: #667;
}
.abtn:hover { background: #1a1a3a; border-color: #446; color: #99b; }
.abtn.on { background: #192d5a; border-color: #5577ff; color: #aaccff;
    box-shadow: 0 0 8px #3355ff33; }
.abtn .ai { font-size: 18px; line-height: 1.1; }
.abtn .an { font-size: 10px; font-weight: 700; }
.abtn .ad { font-size: 8.5px; color: #445; }
.abtn.on .ad { color: #6688aa; }

#status { height: 18px; font-size: 12px; color: #88aaff; margin-bottom: 6px; text-align: center; }
canvas { border: 1px solid #1a1a33; border-radius: 3px; display: block; }
#legend {
    display: flex; flex-wrap: wrap; gap: 4px 13px;
    margin-top: 9px; font-size: 10.5px; color: #556; justify-content: center;
}
.leg { display: flex; align-items: center; gap: 4px; }
.dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
</style>
</head>
<body>
<h1>ğŸ§© ë¯¸ë¡œ íƒìƒ‰ ì‹œë®¬ë ˆì´ì…˜</h1>

<div class="row">
    <button id="btnNew">ğŸ—º ìƒˆ ë¯¸ë¡œ</button>
    <button id="btnStart">â–¶ ì‹œì‘</button>
    <button id="btnStop">â¹ ì¤‘ì§€</button>
    <span class="lbl">ì†ë„</span>
    <input type="range" id="spdSlider" min="1" max="60" value="20">
    <span id="spdLbl">20</span>
    <button id="sndBtn">ğŸ”Š ì†Œë¦¬</button>
</div>
<div class="row">
    <span class="lbl">í¬ê¸°</span>
    <input type="number" id="sizeInput" min="5" max="50" value="20">
    <span class="lbl">Ã—<span id="sizeLbl">20</span> &nbsp;(5~50)</span>
</div>

<div class="algo-grid" id="algoGrid"></div>
<div id="status">ìƒˆ ë¯¸ë¡œë¥¼ ìƒì„±í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.</div>
<canvas id="c"></canvas>
<div id="legend">
    <div class="leg"><div class="dot" style="background:#ffd700"></div><span>íƒìƒ‰ ì¤‘</span></div>
    <div class="leg"><div class="dot" style="background:#0d405a"></div><span>ë°©ë¬¸</span></div>
    <div class="leg"><div class="dot" style="background:#350a45"></div><span>ë§‰íŒ ê¸¸</span></div>
    <div class="leg"><div class="dot" style="background:#3a1200"></div><span>BiDi-ëª©í‘œì¸¡</span></div>
    <div class="leg"><div class="dot" style="background:#2a0808"></div><span>ë§‰íŒê¸¸ì œê±°</span></div>
    <div class="leg"><div class="dot" style="background:#00cc66"></div><span>ìµœë‹¨ê²½ë¡œ(2ë‹¨ê³„)</span></div>
</div>

<script>
// â”€â”€ ì•Œê³ ë¦¬ì¦˜ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ALGOS = [
    {id:'dfs',    icon:'ğŸ”', name:'DFS',    desc:'ê¹Šì´ìš°ì„ '},
    {id:'bfs',    icon:'ğŸŒŠ', name:'BFS',    desc:'ë„ˆë¹„ìš°ì„ '},
    {id:'astar',  icon:'â­', name:'Aâ˜…',     desc:'ìµœë‹¨ìœ ë„'},
    {id:'lhr',    icon:'ğŸ‘ˆ', name:'ì™¼ì†ë²•ì¹™', desc:'ì¢Œí¸í–¥DFS'},
    {id:'random', icon:'ğŸ²', name:'ë¬´ì‘ìœ„',  desc:'ëœë¤DFS'},
    {id:'tremaux',icon:'ğŸ—ºï¸', name:'íŠ¸ë ˆëª¨',  desc:'í†µë¡œí‘œì‹œ'},
    {id:'deadend',icon:'ğŸ§¹', name:'ë§‰íŒê¸¸â†“',  desc:'ë§‰íŒê¸¸ì œê±°'},
    {id:'bidi',   icon:'â†•ï¸', name:'ì–‘ë°©í–¥',  desc:'ì–‘ë°©í–¥BFS'},
];
let curAlgo = 'dfs';

// â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ROWS=20, COLS=20, CS=28;
let walls=null, p1Steps=[], bfsPath=[];
// ì…€ ìƒíƒœ: 0=ë¯¸ë°©ë¬¸ 1=ë°©ë¬¸ 2=ë§‰í˜ 3=BFSê²½ë¡œì˜ˆì•½ 4=BFSí†µê³¼ 5=biDiA 6=biDiB 7=ë§‰íŒê¸¸
let cellSt=[], agent=[0,0], agentB=null;
let phase='idle', idx=0, timer=null;
let soundOn=true, audioCtx=null;
// íŠ¸ë ˆëª¨ í†µë¡œ ë§ˆí¬ (ROWSÃ—COLSÃ—4)
let pMark=null;

const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
function CENTER(){ return [ROWS>>1, COLS>>1]; }
function updateCanvas(){
    const avail=Math.min(560,(window.innerWidth||600)-28);
    CS=Math.max(6,Math.floor(avail/Math.max(ROWS,COLS)));
    canvas.width=COLS*CS+1; canvas.height=ROWS*CS+1;
}

// â”€â”€ ë°©í–¥ (0=N 1=E 2=S 3=W) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DIRS4=[
    [-1, 0,'top',   'bottom'],
    [ 0, 1,'right', 'left'  ],
    [ 1, 0,'bottom','top'   ],
    [ 0,-1,'left',  'right' ],
];
const W4=['top','right','bottom','left'];
const DR4=[-1,0,1,0], DC4=[0,1,0,-1];
function dIdx(dr,dc){ return dr<0?0:dc>0?1:dr>0?2:3; }
function inBounds(r,c){ return r>=0&&r<ROWS&&c>=0&&c<COLS; }
function canGo(r,c,d){ return !walls[r][c][W4[d]]&&inBounds(r+DR4[d],c+DC4[d]); }

function shuffle(a){
    for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]];}
    return a;
}

// â”€â”€ ë¯¸ë¡œ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function genMaze(){
    walls=Array.from({length:ROWS},()=>
        Array.from({length:COLS},()=>({top:true,right:true,bottom:true,left:true})));
    const vis=Array.from({length:ROWS},()=>Array(COLS).fill(false));
    const stk=[[0,0,shuffle([0,1,2,3])]];
    vis[0][0]=true;
    while(stk.length){
        const [r,c,dirs]=stk[stk.length-1];
        if(!dirs.length){stk.pop();continue;}
        const d=dirs.pop(), nr=r+DR4[d], nc=c+DC4[d];
        if(!inBounds(nr,nc)||vis[nr][nc]) continue;
        walls[r][c][W4[d]]=false; walls[nr][nc][W4[(d+2)%4]]=false;
        vis[nr][nc]=true; stk.push([nr,nc,shuffle([0,1,2,3])]);
    }
}

// â”€â”€ ê³µí†µ DFS í”„ë ˆì„ì›Œí¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// getDirOrder(facing) â†’ ë°©í–¥ ì¸ë±ìŠ¤ ë°°ì—´ (ìš°ì„ ìˆœìœ„ ìˆœì„œ)
function buildGenericDFS(getDirOrder){
    const [cr,cc]=CENTER();
    const steps=[{act:'move',r:0,c:0}];
    const vis=new Set(['0,0']);
    // ìŠ¤íƒ: [r, c, ë‚¨ì€ë°©í–¥ë°°ì—´, facing]
    const stk=[[0,0,[...getDirOrder(1)],1]]; // ì´ˆê¸° facing=East
    let found=false;
    while(stk.length&&!found){
        const top=stk[stk.length-1];
        const [r,c,dq]=top;
        if(r===cr&&c===cc){found=true;break;}
        let moved=false;
        while(dq.length){
            const d=dq.shift();
            const nr=r+DR4[d],nc=c+DC4[d],key=`${nr},${nc}`;
            if(inBounds(nr,nc)&&!walls[r][c][W4[d]]&&!vis.has(key)){
                vis.add(key);
                steps.push({act:'move',r:nr,c:nc});
                stk.push([nr,nc,[...getDirOrder(d)],d]);
                moved=true; break;
            }
        }
        if(!moved){
            stk.pop();
            if(stk.length){
                const [pr,pc]=stk[stk.length-1];
                steps.push({act:'back',r:pr,c:pc,fr:r,fc:c});
            }
        }
    }
    return steps;
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 1: DFS (ê³ ì • ìˆœì„œ Nâ†’Eâ†’Sâ†’W) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDFS(){
    return buildGenericDFS(_facing=>[0,1,2,3]);
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 2: BFS (ë„ˆë¹„ìš°ì„  ë¬¼ê²°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBFS(){
    const [cr,cc]=CENTER();
    const steps=[{act:'move',r:0,c:0}];
    const vis=new Set(['0,0']); const q=[[0,0]];
    while(q.length){
        const [r,c]=q.shift();
        if(r===cr&&c===cc) break;
        for(let d=0;d<4;d++){
            if(!canGo(r,c,d)) continue;
            const nr=r+DR4[d],nc=c+DC4[d],key=`${nr},${nc}`;
            if(!vis.has(key)){vis.add(key);steps.push({act:'move',r:nr,c:nc});q.push([nr,nc]);}
        }
    }
    return steps;
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 3: Aâ˜… (Manhattan íœ´ë¦¬ìŠ¤í‹±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAStar(){
    const [cr,cc]=CENTER();
    const h=(r,c)=>Math.abs(r-cr)+Math.abs(c-cc);
    const steps=[{act:'move',r:0,c:0}];
    const vis=new Set(); const dist=new Map([['0,0',0]]);
    const pq=[{r:0,c:0,g:0,f:h(0,0)}];
    while(pq.length){
        pq.sort((a,b)=>a.f-b.f);
        const {r,c,g}=pq.shift(); const key=`${r},${c}`;
        if(vis.has(key)) continue;
        vis.add(key);
        if(r!==0||c!==0) steps.push({act:'move',r,c});
        if(r===cr&&c===cc) break;
        for(let d=0;d<4;d++){
            if(!canGo(r,c,d)) continue;
            const nr=r+DR4[d],nc=c+DC4[d],nk=`${nr},${nc}`;
            if(!vis.has(nk)){
                const ng=g+1;
                if(!dist.has(nk)||ng<dist.get(nk)){
                    dist.set(nk,ng); pq.push({r:nr,c:nc,g:ng,f:ng+h(nr,nc)});
                }
            }
        }
    }
    return steps;
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 4: ì™¼ì†ë²•ì¹™ DFS (ì¢Œí¸í–¥) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// facing ë°©í–¥ ê¸°ì¤€ìœ¼ë¡œ ì¢Œâ†’ì§ì§„â†’ìš°â†’ë’¤ ìˆœì„œ
function buildLHR(){
    return buildGenericDFS(facing=>[(facing+3)%4, facing, (facing+1)%4, (facing+2)%4]);
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 5: ë¬´ì‘ìœ„ DFS (ë§¤ ì…€ë§ˆë‹¤ ë°©í–¥ ì…”í”Œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildRandom(){
    return buildGenericDFS(_=>shuffle([0,1,2,3]));
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 6: íŠ¸ë ˆëª¨ (í†µë¡œ ë§ˆí¬ ê¸°ë°˜, ë¯¸ë°©ë¬¸ ìš°ì„ ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í†µë¡œì— ë§ˆí¬(0,1,2) ë¶€ì°©. ë§ˆí¬ 2ì¸ í†µë¡œëŠ” ì ˆëŒ€ ì¬ì§„ì… ì•ˆí•¨.
// ë¯¸ë°©ë¬¸(0) ìš°ì„  â†’ 1íšŒ í†µê³¼(1) í—ˆìš© â†’ 2íšŒ ë¶ˆê°€
// ì™„ì „ ë¯¸ë¡œì—ì„œëŠ” DFSì™€ ë™ì¼ ê²½ë¡œì§€ë§Œ í†µë¡œ ìƒ‰ìƒìœ¼ë¡œ ì‹œê°í™”
function buildTremaux(){
    const [cr,cc]=CENTER();
    const steps=[{act:'move',r:0,c:0}];
    // pm[r][c][d]: í•´ë‹¹ ë°©í–¥ìœ¼ë¡œ ë‚˜ê°„ íšŸìˆ˜
    const pm=Array.from({length:ROWS},()=>Array.from({length:COLS},()=>Array(4).fill(0)));
    const vis=new Set(['0,0']);
    const stk=[[0,0]]; // ë°©ë¬¸ ê²½ë¡œ ìŠ¤íƒ
    let r=0,c=0; let found=false;

    while(stk.length&&!found){
        if(r===cr&&c===cc){found=true;break;}
        // ë¯¸ë°©ë¬¸ ì¸ì ‘ì…€ ìš°ì„ , ê·¸ ë‹¤ìŒ 1íšŒë§ˆí¬í†µë¡œ
        let bestD=-1, bestM=3;
        for(let d=0;d<4;d++){
            if(!canGo(r,c,d)) continue;
            const nr=r+DR4[d],nc=c+DC4[d];
            const m=pm[r][c][d]; // ì´ ë°©í–¥ìœ¼ë¡œ ë‚˜ê°„ íšŸìˆ˜
            if(m>=2) continue;  // 2íšŒ ì´ìƒ í†µê³¼í•œ í†µë¡œ ê¸ˆì§€
            const notVisited=!vis.has(`${nr},${nc}`);
            const score=notVisited?0:m+1; // ë¯¸ë°©ë¬¸=0, 1íšŒ=2
            if(score<bestM){bestM=score;bestD=d;}
        }
        if(bestD===-1){
            // ë§‰í˜ â†’ ì—­ì¶”ì 
            stk.pop();
            if(stk.length){
                const [pr,pc]=stk[stk.length-1];
                steps.push({act:'back',r:pr,c:pc,fr:r,fc:c,pm:pm});
                r=pr;c=pc;
            }
        } else {
            // ì´ë™
            pm[r][c][bestD]++;
            const nr=r+DR4[bestD],nc=c+DC4[bestD];
            pm[nr][nc][(bestD+2)%4]++;
            vis.add(`${nr},${nc}`);
            r=nr;c=nc;
            stk.push([r,c]);
            steps.push({act:'move',r,c,pm:JSON.parse(JSON.stringify(pm))});
        }
    }
    return steps;
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 7: ë§‰íŒê¸¸ ì œê±° (Dead-end Fill) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë§‰íŒ ì…€(í†µë¡œ 1ê°œ)ì„ ë°”ê¹¥ì—ì„œ ì•ˆìœ¼ë¡œ ì ì§„ì ìœ¼ë¡œ ì±„ì›Œì„œ í•´ë‹µ ê²½ë¡œë§Œ ë‚¨ê¹€
function buildDeadEnd(){
    const [cr,cc]=CENTER();
    const steps=[];
    const filled=Array.from({length:ROWS},()=>Array(COLS).fill(false));

    // ì—´ë¦° í†µë¡œ ìˆ˜ ê³„ì‚° (ì±„ì›Œì§„ ì…€ ì œì™¸)
    function openCount(r,c){
        let cnt=0;
        for(let d=0;d<4;d++) if(canGo(r,c,d)&&!filled[r+DR4[d]][c+DC4[d]]) cnt++;
        return cnt;
    }

    // ë§‰íŒ ì…€ ë°˜ë³µ ì œê±°
    let changed=true;
    while(changed){
        changed=false;
        for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
            if(filled[r][c]) continue;
            if((r===0&&c===0)||(r===cr&&c===cc)) continue; // ì¶œë°œ/ë„ì°© ë³´í˜¸
            if(openCount(r,c)===1){
                filled[r][c]=true;
                steps.push({act:'fill',r,c});
                changed=true;
            }
        }
    }
    // ë‚¨ì€ ì…€(í•´ë‹µ ê²½ë¡œ)ì— BFSë¡œ ì´ë™ ê²½ë¡œ ì¶”ê°€
    const parent=new Map([['0,0',null]]);
    const q=[[0,0]];
    while(q.length){
        const [r,c]=q.shift();
        if(r===cr&&c===cc) break;
        for(let d=0;d<4;d++){
            if(!canGo(r,c,d)) continue;
            const nr=r+DR4[d],nc=c+DC4[d],nk=`${nr},${nc}`;
            if(!parent.has(nk)&&!filled[nr][nc]){parent.set(nk,[r,c]);q.push([nr,nc]);}
        }
    }
    let pos=[cr,cc]; const solPath=[];
    while(pos){solPath.unshift(pos);pos=parent.get(`${pos[0]},${pos[1]}`);}
    for(const [r,c] of solPath) steps.push({act:'sol',r,c});
    return steps;
}

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ 8: ì–‘ë°©í–¥ BFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBidi(){
    const [cr,cc]=CENTER();
    const steps=[];
    const visA=new Map([['0,0',null]]);
    const visB=new Map([[`${cr},${cc}`,null]]);
    const qA=[[0,0]], qB=[[cr,cc]];
    let meet=null;
    outer:
    while((qA.length||qB.length)&&!meet){
        // A í™•ì¥
        if(qA.length){
            const [r,c]=qA.shift();
            steps.push({act:'a',r,c});
            for(let d=0;d<4;d++){
                if(!canGo(r,c,d)) continue;
                const nr=r+DR4[d],nc=c+DC4[d],nk=`${nr},${nc}`;
                if(!visA.has(nk)){
                    visA.set(nk,[r,c]);
                    if(visB.has(nk)){meet=nk;break outer;}
                    qA.push([nr,nc]);
                }
            }
        }
        // B í™•ì¥
        if(qB.length){
            const [r,c]=qB.shift();
            steps.push({act:'b',r,c});
            for(let d=0;d<4;d++){
                if(!canGo(r,c,d)) continue;
                const nr=r+DR4[d],nc=c+DC4[d],nk=`${nr},${nc}`;
                if(!visB.has(nk)){
                    visB.set(nk,[r,c]);
                    if(visA.has(nk)){meet=nk;break outer;}
                    qB.push([nr,nc]);
                }
            }
        }
    }
    return steps;
}

// â”€â”€ BFS ìµœë‹¨ê²½ë¡œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBfsPath(){
    const [cr,cc]=CENTER();
    const parent=new Map([['0,0',null]]); const q=[[0,0]];
    while(q.length){
        const [r,c]=q.shift();
        if(r===cr&&c===cc) break;
        for(let d=0;d<4;d++){
            if(!canGo(r,c,d)) continue;
            const nr=r+DR4[d],nc=c+DC4[d],nk=`${nr},${nc}`;
            if(!parent.has(nk)){parent.set(nk,[r,c]);q.push([nr,nc]);}
        }
    }
    const path=[]; let pos=[cr,cc];
    while(pos){path.unshift(pos);pos=parent.get(`${pos[0]},${pos[1]}`);}
    return path;
}

function buildSteps(){
    pMark=null;
    const fn={dfs:buildDFS,bfs:buildBFS,astar:buildAStar,lhr:buildLHR,
              random:buildRandom,tremaux:buildTremaux,deadend:buildDeadEnd,bidi:buildBidi};
    return (fn[curAlgo]||buildDFS)();
}

// â”€â”€ ì†Œë¦¬ (íœíƒ€í† ë‹‰) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PENTA=[261.6,293.7,349.2,392.0,440.0,523.3,587.3,659.3,783.9];
function getAC(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function tone(freq,dur,vol=0.07,type='sine'){
    if(!soundOn||getDelay()<18) return;
    try{const ac=getAC(),o=ac.createOscillator(),g=ac.createGain();
        o.connect(g);g.connect(ac.destination);o.type=type;o.frequency.value=freq;
        g.gain.setValueAtTime(vol,ac.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);
        o.start();o.stop(ac.currentTime+dur+0.01);}catch(e){}
}
function playMove(r,c){
    const [cr,cc]=CENTER(),md=cr+cc,d=Math.abs(r-cr)+Math.abs(c-cc);
    tone(PENTA[Math.min(8,Math.floor((1-d/md)*6)+2)],0.07,0.065);
}
function playBack(){tone(PENTA[1],0.09,0.05);}
function playArrive(){if(!soundOn)return;[523.3,659.3,783.9,1046.5].forEach((f,i)=>setTimeout(()=>tone(f,0.25,0.12),i*130));}
function playP2(){if(!soundOn)return;[392,523.3].forEach((f,i)=>setTimeout(()=>tone(f,0.2,0.1),i*100));}

// â”€â”€ ê·¸ë¦¬ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COL={
    bg:'#080818',floor:'#0e0e22',
    v1:'#0d3a4a', v2:'#2e0a3e', v3:'#062818', v4:'#0a4028',
    va:'#0d2a4a', vb:'#3a1800', vf:'#2a0808',
    cor:'#182448', wall:'#4455bb',
    ag1:'#ffd700', ag2:'#00ffcc', agb:'#ff7733',
    S:'#00ff88', G:'#ff5555',
    // íŠ¸ë ˆëª¨ í†µë¡œ ë§ˆí¬ ìƒ‰
    tm1:'#cc8800', tm2:'#cc3300',
};
const ccx=c=>c*CS+CS/2, ccy=r=>r*CS+CS/2;

function draw(){
    ctx.fillStyle=COL.bg; ctx.fillRect(0,0,canvas.width,canvas.height);
    if(!walls) return;

    // 1. ì…€ ìƒ‰ìƒ
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
        const st=cellSt[r]?.[c]??0;
        ctx.fillStyle=st===1?COL.v1:st===2?COL.v2:st===3?COL.v3:st===4?COL.v4
                     :st===5?COL.va:st===6?COL.vb:st===7?COL.vf:COL.floor;
        ctx.fillRect(c*CS+1,r*CS+1,CS-1,CS-1);
    }

    // 2. í†µë¡œ ë¼ì¸ (íŠ¸ë ˆëª¨: ë§ˆí¬ ìƒ‰, ê·¸ ì™¸: ê¸°ë³¸ dim)
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
        const drawLine=(r1,c1,r2,c2,m)=>{
            let col=COL.cor;
            if(curAlgo==='tremaux'&&pMark){
                const t=pMark[r1]?.[c1];
                if(t) col=t[dIdx(r2-r1,c2-c1)]>=2?COL.tm2:t[dIdx(r2-r1,c2-c1)]>=1?COL.tm1:COL.cor;
            }
            ctx.strokeStyle=col; ctx.lineWidth=curAlgo==='tremaux'&&col!==COL.cor?2:1;
            ctx.beginPath(); ctx.moveTo(ccx(c1),ccy(r1)); ctx.lineTo(ccx(c2),ccy(r2)); ctx.stroke();
        };
        if(c+1<COLS&&!walls[r][c].right) drawLine(r,c,r,c+1);
        if(r+1<ROWS&&!walls[r][c].bottom) drawLine(r,c,r+1,c);
    }

    // 3. ë²½ ë¼ì¸
    ctx.strokeStyle=COL.wall; ctx.lineWidth=CS>12?1.5:1;
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
        const x=c*CS,y=r*CS,w=walls[r][c];
        const ln=(x1,y1,x2,y2)=>{ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();};
        if(w.top)    ln(x,y,x+CS,y);
        if(w.left)   ln(x,y,x,y+CS);
        if(w.bottom) ln(x,y+CS,x+CS,y+CS);
        if(w.right)  ln(x+CS,y,x+CS,y+CS);
    }

    // 4. S/G ë§ˆì»¤
    if(CS>=9){
        ctx.font=`bold ${Math.max(8,CS/3|0)}px monospace`;
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillStyle=COL.S; ctx.fillText('S',ccx(0),ccy(0));
        const [cr2,cc2]=CENTER();
        ctx.fillStyle=COL.G; ctx.fillText('G',ccx(cc2),ccy(cr2));
    }

    // 5. ì—ì´ì „íŠ¸
    const drawAgent=(pos,col)=>{
        if(!pos) return;
        const [ar,ac]=pos, rad=Math.max(2,CS/2-(CS>15?3:1));
        ctx.beginPath(); ctx.arc(ccx(ac),ccy(ar),rad,0,Math.PI*2);
        ctx.fillStyle=col; ctx.fill();
        if(CS>10){ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=1;ctx.stroke();}
    };
    if(phase!=='idle'){
        const col=(phase==='bfs'||phase==='done')?COL.ag2:COL.ag1;
        drawAgent(agent,col);
        if(curAlgo==='bidi'&&phase==='p1') drawAgent(agentB,COL.agb);
    }
}

// â”€â”€ ì• ë‹ˆë©”ì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const stopTimer=()=>{if(timer){clearTimeout(timer);timer=null;}};
const getDelay=()=>Math.round(508-+document.getElementById('spdSlider').value*8);
const schedule=()=>{timer=setTimeout(tick,getDelay());};
const setStatus=m=>{document.getElementById('status').textContent=m;};

function tick(){
    if(phase==='p1'){
        if(idx>=p1Steps.length){
            const name=ALGOS.find(a=>a.id===curAlgo)?.name||'';
            setStatus(`âœ” 1ë‹¨ê³„ ${name} ì™„ë£Œ (${p1Steps.length} ìŠ¤í…) â†’ ìµœë‹¨ê²½ë¡œ ì‹œì‘â€¦`);
            playArrive(); timer=setTimeout(startP2,900); return;
        }
        const s=p1Steps[idx++];
        // íŠ¸ë ˆëª¨ í†µë¡œ ë§ˆí¬ ì—…ë°ì´íŠ¸
        if(s.pm) pMark=s.pm;

        if(s.act==='move'){
            agent=[s.r,s.c];
            if(!(cellSt[s.r]?.[s.c]>0)) cellSt[s.r][s.c]=1;
            playMove(s.r,s.c);
        } else if(s.act==='back'){
            cellSt[s.fr][s.fc]=2; agent=[s.r,s.c]; playBack();
        } else if(s.act==='a'){  // BiDi A
            agent=[s.r,s.c];
            if(!(cellSt[s.r]?.[s.c]>0)) cellSt[s.r][s.c]=5;
            playMove(s.r,s.c);
        } else if(s.act==='b'){  // BiDi B
            agentB=[s.r,s.c];
            if(!(cellSt[s.r]?.[s.c]>0)) cellSt[s.r][s.c]=6;
            tone(PENTA[2],0.07,0.065);
        } else if(s.act==='fill'){  // ë§‰íŒê¸¸ ì œê±°
            agent=[s.r,s.c]; cellSt[s.r][s.c]=7;
            tone(PENTA[0],0.05,0.04);
        } else if(s.act==='sol'){  // ë§‰íŒê¸¸ì œê±° - í•´ë‹µê²½ë¡œ
            agent=[s.r,s.c];
            if(cellSt[s.r][s.c]===0) cellSt[s.r][s.c]=1;
            playMove(s.r,s.c);
        }
        draw();
        const name=ALGOS.find(a=>a.id===curAlgo)?.name||'';
        setStatus(`[1ë‹¨ê³„ ${name}]  ${idx} / ${p1Steps.length} ìŠ¤í…`);
        schedule();

    } else if(phase==='bfs'){
        if(idx>=bfsPath.length){
            phase='done'; draw(); playArrive();
            setStatus(`ğŸ ì™„ë£Œ! ìµœë‹¨ê²½ë¡œ ${bfsPath.length-1} ìŠ¤í…`); return;
        }
        const [r,c]=bfsPath[idx++];
        agent=[r,c]; cellSt[r][c]=4; playMove(r,c);
        draw();
        setStatus(`[2ë‹¨ê³„ BFS ìµœë‹¨ê²½ë¡œ]  ${idx} / ${bfsPath.length} ìŠ¤í…`);
        schedule();
    }
}

function startP2(){
    phase='bfs'; idx=0; agent=[0,0]; agentB=null;
    for(const [r,c] of bfsPath) if((cellSt[r]?.[c]??0)<3) cellSt[r][c]=3;
    draw(); playP2();
    setStatus(`[2ë‹¨ê³„ BFS ìµœë‹¨ê²½ë¡œ ì‹œì‘]  ì´ ${bfsPath.length-1} ìŠ¤í…`);
    schedule();
}

// â”€â”€ ìƒˆ ë¯¸ë¡œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newMaze(){
    stopTimer();
    const n=Math.max(5,Math.min(50,parseInt(document.getElementById('sizeInput').value)||20));
    ROWS=COLS=n;
    document.getElementById('sizeInput').value=n;
    document.getElementById('sizeLbl').textContent=n;
    updateCanvas();
    phase='idle'; agent=[0,0]; agentB=null; pMark=null;
    cellSt=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    genMaze(); p1Steps=buildSteps(); bfsPath=buildBfsPath();
    draw();
    const name=ALGOS.find(a=>a.id===curAlgo)?.name||'';
    setStatus(`ìƒì„± ì™„ë£Œ (${ROWS}Ã—${COLS})  |  ${name} ${p1Steps.length}ìŠ¤í…  /  ìµœë‹¨ ${bfsPath.length-1}ìŠ¤í…`);
}

// â”€â”€ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btnNew').onclick=newMaze;
document.getElementById('btnStart').onclick=()=>{
    if(!walls){setStatus('ë¨¼ì € ìƒˆ ë¯¸ë¡œë¥¼ ìƒì„±í•˜ì„¸ìš”!');return;}
    if(phase==='p1'||phase==='bfs') return;
    stopTimer(); phase='p1'; idx=0; agent=[0,0]; agentB=null; pMark=null;
    cellSt=Array.from({length:ROWS},()=>Array(COLS).fill(0));
    draw(); setStatus('[1ë‹¨ê³„ íƒìƒ‰ ì‹œì‘â€¦]'); schedule();
};
document.getElementById('btnStop').onclick=()=>{
    stopTimer();
    if(phase==='p1'||phase==='bfs'){phase='idle';setStatus('â¹ ì¤‘ì§€ë¨.');}
};
document.getElementById('spdSlider').oninput=function(){
    document.getElementById('spdLbl').textContent=this.value;};
const sndBtn=document.getElementById('sndBtn');
sndBtn.onclick=()=>{
    soundOn=!soundOn;
    sndBtn.textContent=soundOn?'ğŸ”Š ì†Œë¦¬':'ğŸ”‡ ì†Œë¦¬';
    sndBtn.classList.toggle('off',!soundOn);
};

// â”€â”€ ì•Œê³ ë¦¬ì¦˜ ë²„íŠ¼ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const grid=document.getElementById('algoGrid');
ALGOS.forEach(({id,icon,name,desc})=>{
    const btn=document.createElement('button');
    btn.className='abtn'+(id===curAlgo?' on':'');
    btn.innerHTML=`<span class="ai">${icon}</span><span class="an">${name}</span><span class="ad">${desc}</span>`;
    btn.onclick=()=>{
        curAlgo=id;
        document.querySelectorAll('.abtn').forEach(b=>b.classList.remove('on'));
        btn.classList.add('on');
        if(walls&&phase==='idle'){
            p1Steps=buildSteps();
            setStatus(`ì•Œê³ ë¦¬ì¦˜: ${name}  |  ${p1Steps.length}ìŠ¤í…  /  ìµœë‹¨ ${bfsPath.length-1}ìŠ¤í…`);
        }
    };
    grid.appendChild(btn);
});

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
newMaze();
</script>
</body>
</html>
